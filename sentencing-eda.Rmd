---
output: html_document
---

# Data exploration

Alright, let's start digging into the data. Whenever you are handed a new dataset, you want to read in the data so you can view it in RStudio and perform an Exploratory Data Analysis (EDA). 

## Reading in the data

You can read in your data using `read_csv()` and creating a variable named `us_sent` that refers to the dataset. To view the data as a spreadsheet in a new tab within RStudio, you can use the `View()` function. Because this is an interactive RStudio function that doesn't work when we knit the document, we have set up our document so that the code can be viewed below but not actually run when we knit (specifically, we used the code chunk option `eval = FALSE`). 

```{r read in data, include = FALSE}
us_sent <- read_csv("data/cleaned_data_renamed.csv")
```

```{r view data, eval = FALSE}
View(us_sent)
```

## Structure of the data

In a tidy dataset, each row is an observation, each column is a variable, and each cell is a value.

In the case of the federal criminal sentencing data, each row represents an individual who was sentenced in the federal district court system in the U.S. in one of the country's 94 districts.

When we start with a dataset, we will want to think about and explore some key questions related to who is in our dataset, what the sentence was, when the individual was sentenced and where the sentence occurred. Can you guess which variables pertain to each question?

Let's inspect our variables, which are in the columns, and see if that helps. There are several functions we can use to do this:

* `names()` will provide the names of the columns in the dataset
    ```{r check column names}
    names(us_sent)
    ```
    
* `summary()` will provide the names of the columns in the dataset along with a brief numeric or qualitative summary of each variable

    ```{r check column summaries}
    summary(us_sent)
    ```

* `str()` will display (sometimes complex) details of the internal structure of the R object, including the table dimensions, variable names, variable types, and the first 10 observations for each variable within a data table

    ```{r check object structure}
    str(us_sent)
    ```
    
* `glimpse()` is a simplified version of `str()` that only displays the dimensions, variable names, variable types, and the first set of observations for each variable within a data table (how many observations depends on the width of your output)

    ```{r get glimpse of data}
    glimpse(us_sent)
    ```
    
> Note: You can use the built in R help documentation to learn more about each function by typing a question mark followed by the name of the function in the console, e.g. `?str()` 

## Data Types

What is halfway between 0 and 1? It is 1/2. What is halfway between horse and dog? There is no such thing! Thinking about each type of data is very important so that we don't code silly things like the mean of animal species!

There are two main types of data: **categorical data** and **numerical data**. Some examples of categorical data would be color, ethnicity, employment status, or states/countries. These have unique values, like California or Oregon.

Some examples of numerical data are temperature, height and salary. It makes perfect sense to be 165.8 cm tall or for the temperature to be 82.4 degrees outside.

There are some confusing data types that use numbers to *represent* categorical data, like zip code. You may live in the zip code 90201, which is a number, but you can't live in the zip code 90210.3. Only whole numbers, and specific ones at that, make sense here. We will learn more about using numbers to represent categorical data in this lesson.

Can you identify which data type each variable in the federal criminal sentencing data is?

## Explorations

A good practice to do with a new data set is to explore it through visualization. We will walk through a few graphs in R so you can see how to plot. We will examine each of these so we can see relationships and learn more about our data. Then, explore on your own by modifying this code!


## How to make a scatter plot with quantitative variables

In this first plot, we will look at numerical variables only. We will see how each the age of a defendant relates to sentence length. 

Each dot in the scatter plot we produce with the `ggplot` command represents a row in our `us_sent` data. Scatter plots help us to visualize and understand numerical data better. We will compare each defendant's age to their sentence length through visualization and observation. We will use this scatter plot to identify any patterns that exist in our data set.

To use `ggplot`, we start by indicating what dataset we want to plot then what our variables of interest are--in this case, we are interested in `age` and `sentence_length`. `geom_point` specifies that we are interested in using a scatter plot to represent our data. There are many fun and useful modifications that change the way a scatter plot looks. For example, you can change the color of data points using `color`, you can change the size of data points using `size`, and you can specify the transparency of data points using `alpha`. It's also good practice to come up with a useful title and good axis labels using the `labs` command.

```{r sentence length by age}
ggplot(us_sent, aes(x = age, 
                    y = sentence_length)) + 
  geom_point(color = 'coral2',
             size = 0.5,
             alpha = 0.4) +
  labs(title = "Sentence Length by Age",
       x = "Age (Years)",
       y = "Sentence Length (Months)")
```

What do you notice in this scatter plot? What do you wonder?

## What happens when you try to make a scatter plot with categorical variables?

We just created a scatter plot with two numerical variables. Now we will see what happens if one variable is numerical and the other is categorical. Run the code below that plots `criminal_history` (a categorical variable) against `age` (a numerical variable).

```{r criminal history by age}
ggplot(us_sent, aes(x = age, 
                    y = criminal_history)) + 
  geom_point(color = 'coral2', 
             alpha = 0.7) +
  labs(title = "Criminal history by age",
       x = "Age (Years)",
       y = "Criminal History (1-6 levels)") # come back to this
```

What do you notice in this scatter plot? What do you wonder?

## What happens when you try to make a scatterplot with two catergoical variables?

Let's try one more scenario. What happens when you try to plot two categorical variables against each other? Run the code below to plot sex against species (both categorical variables).

```{r race by sex}
ggplot(us_sent, aes(x = race,
                    y = sex)) + 
  geom_point(color = 'coral2', 
             alpha = 0.7) +
  labs(title = "Age by Sex",
       x = "Age (Years)",
       y = "Sex (Male or Female)")
```

What do you notice in this scatter plot? What do you wonder?

As you may have noted, scatter plots of two categorical variables are not that useful for analysis and inference since they only display the way we've grouped our data and not any of the underlying patterns. To compare two categorical variables frequency tables or bar graphs are a better visualization to use. In the remainder of this lesson we will focus on comparisons where we have *at least one numerical variable*.


### Explanatory Data Analysis
<!-- - explain the different columns (linking to the background) -->
Now, let's return to exploring the variables of interest. Remember, we want to know *who* is in our dataset, *what* the sentence was, *when* the individual was sentenced and *where* the sentence occurred. Can you identify some of the variables that might correspond with each of these questions? We'll define and explore variables in more detail next.

<!-- https://www.nature.com/articles/s41599-023-01879-5 -->

|Who | What| When | Where |
|:---|:---|:---|:---|
| `age` | `sentence_length` | `year` | `district` |
| `sex` | `mandatory_min` | | |
| `educ` | |||
| `race` | |||
| `criminal_history` | |||
| `guilty_plea` | |||


<!-- ### Who {.tabset}

A key motivation for this work is exploring how our personal and racial identities influence the judicial sentencing. In a fair, democratic system this identity or perceived identity should not affect how we are treated by the justice system.

In this dataset, as you may have guessed, we have four variables that are related to identity: `age`, `sex`, `educ` (education), and `race`. It is important to note that these characteristics are not independent of one another but can intersect and interact with one another. This combined effect is known as intersectionality. The Center for Intersectional Justice describes the concept of intersectionality as: "the ways in which systems of inequality based on gender, race, ethnicity, sexual orientation, gender identity, disability, class and other forms of discrimination 'intersect' to create unique dynamics and effects" (Ref: [Center for Intersectional Justice](https://www.intersectionaljustice.org/what-is-intersectionality), July 20, 2023). -->

#### Sex 

Remember that `sex` has been coded as a binary variable 0 and 1, where 0 is "Male" and 1 is "Female".

```{r}
us_sent %>%
  distinct(sex)
```

We can recode this variable using `mutate` and `case_when`

**To add**

- Add how sex was defined (sex is defined in pre-sentencing report that comes out of the investigation done by the probation office. This goes to the attorneys and also comes out of an interview with the individual. It should be noted that there are only two categories, so it is likely that there might be only two options possible). See Background section or link to official report for more information.
- Discuss how a binary variable will not reflect sentenced individuals gender identity and excludes several groups. It is also limiting in nature.
- Discuss difference between sex and gender
- Discuss who has defined this variable and why this is problematic
- Discuss the limitations and how this affects the analysis and inferences we can make.
- Update sex label with more appropriate label based on Background research.


```{r}
us_sent %>%
  mutate(sex = case_when(sex == 0 ~ "Male",
                         sex == 1 ~ "Female")) %>%
  ggplot() +
  geom_bar(aes(x = sex, fill = sex)) +
  labs(x = "Sex*",
       title = "Sex* of Sentenced Individuals",
       y = "Number of Individuals",
       fill = "Sex*") +
  scale_fill_viridis_d()
```

#### Race

Now let's explore the `race` variable in a similar way. 

```{r}
us_sent %>%
  distinct(race)
```


```{r}
us_sent %>%
  mutate(race = case_when(race == "other" ~ "ari",
                         TRUE ~ race)) %>%
  ggplot() +
  geom_bar(aes(x = fct_infreq(race), fill = race)) +
  labs(x = "Race*",
       title = "Race* of Sentenced Individuals",
       y = "Number of Individuals",
       fill = "Race*") +
  scale_fill_viridis_d()
```

#### Race and Sex

Now let's look at how `race` and `sex` relate to one another. First, let's look at the number of people in each combination using `count` again. 

```{r}
us_sent %>%
  count(race, sex)
```

We can represent these two variables using a bar graph. Once again we will use `ggplot` to create this plot... 

```{r}
us_sent %>%
  mutate(race = case_when(race == "other" ~ "ari",
                         TRUE ~ race)) %>%
  mutate(sex = case_when(sex == 0 ~ "Male",
                         sex == 1 ~ "Female")) %>%
  ggplot() +
  geom_bar(aes(x = fct_infreq(race), fill = sex)) +
  labs(x = "Race*",
       title = "Race* and Sex* of Sentenced Individuals",
       y = "Number of Individuals",
       fill = "Sex*")  +
  scale_fill_viridis_d()
```

#### Proportional Race and Sex

We can also create a proportional bar plot. 

```{r}
us_sent %>%
  mutate(race = case_when(race == "other" ~ "ari",
                         TRUE ~ race)) %>%
  mutate(sex = case_when(sex == 0 ~ "Male",
                         sex == 1 ~ "Female")) %>%
  ggplot() +
  geom_bar(aes(x = fct_infreq(race), fill = sex), position = "fill") +
  labs(x = "Race*",
       title = "Race* and Sex* of Sentenced Individuals",
       y = "Number of Individuals",
       fill = "Sex*")  +
  scale_fill_viridis_d()
```

#### Age

We might want to explore what the age of different individuals is across districts. Let's explore the districts of Maine, Rhode Island, and Vermont. We can use the `filter` command to look at only these three districts of interest. 

```{r}
us_sent %>%
  filter(district %in% c("Maine", "Rhode Island", "Vermont"))
```


**To add**:
- what do we divide by?
- You may look at this plot and say that whites are sentenced at the federal district court more than black individuals. This is where it is important to look at the population in each district.


**Future Directions**

Bringing in the spatial district files

- https://www.openicpsr.org/openicpsr/project/100069/version/V1/view
- Downloading census data from the API.
- Joining to census data
- Limitations of census data
- Other potential things to mention (the affect of aggregation and spatial scale).


### What

Moving on to answering the "What?" question about our data. You might have guessed that `sentence_length` and `mandatory_min` are the variables that fall under this category. 

#### How does sentence length correlate with criminal history? {.tabset}

Sentence lengths and how do they relate to policy?

When we are exploring the distribution of a dataset can we can use a number of different plots. To better understand sentence length data, weâ€™ll display a histogram for this quantitative variable. A histogram gives us a visual representation of the frequency of values. With R, we can change the width of each bin or choose a number of bins, and then the plot shows us how many sentences fell within each bin range.

##### Histogram

```{r}
ggplot(us_sent) +
  geom_histogram(aes(x = sentence_length), binwidth = 12) +
  labs(x = "Sentence length in months", y = "Number of individuals")  +
  geom_vline(aes(xintercept = 12), color = "red", linetype = 2) +
  geom_vline(aes(xintercept = 60), color = "red", linetype = 2) +
  geom_vline(aes(xintercept = 120), color = "red", linetype = 2) +
  geom_vline(aes(xintercept = 240), color = "red", linetype = 2)
```

##### Histogram

```{r}
ggplot(us_sent) +
  geom_histogram(aes(x = sentence_length/12), binwidth = 1) +
  labs(x = "Sentence length in years", y = "Number of individuals") +
  geom_vline(aes(xintercept = 1), color = "red", linetype = 2) +
  geom_vline(aes(xintercept = 5), color = "red", linetype = 2) +
  geom_vline(aes(xintercept = 10), color = "red", linetype = 2) +
  geom_vline(aes(xintercept = 20), color = "red", linetype = 2) +
  labs(title = "Distribution of number of individuals by ")



```

We observe a high frequency over 0, meaning that many individuals who are convicted may in fact receive a sentence of 0 months. At the other extreme, we see cases corresponding to 470 months, representing individuals who either have been given a long sentence, meaning 39 years or possibly a life sentence.

[could further discuss skew, peaks and relate to sentencing table, etc.]

##### Violin Plot

Violin plots are another way of showing the distribution data.

```{r}
ggplot(us_sent) +
  geom_violin(aes(x = as.factor(criminal_history), 
                  y = sentence_length, 
                  fill = as.factor(criminal_history))) +
  labs(fill = "Criminal History", 
       y = "Sentence length in months", 
       x = "Criminal History")

```

##### Ridge plot

```{r}
ggplot(us_sent) +
  geom_density_ridges(aes(y = as.factor(criminal_history),
                          x = sentence_length,
                          fill = as.factor(criminal_history))) +
  labs(title = "Distribution of sentence length in months by criminal history",
       subtitle = "Black dashed lines indicate 1, 5, 10, 15, and 20 year sentences",
       fill = "Criminal History",
       x = "Sentence length in months",
       y = "Criminal History") +
  geom_vline(aes(xintercept = 12), color = "black", linetype = 2) +
  geom_vline(aes(xintercept = 60), color = "black", linetype = 2) +
  geom_vline(aes(xintercept = 120), color = "black", linetype = 2) +
  geom_vline(aes(xintercept = 180), color = "black", linetype = 2) +
  geom_vline(aes(xintercept = 240), color = "black", linetype = 2) +
  scale_fill_viridis_d()

```

#### What is the relationship between `all_adjustments` and `sentence_length`?

```{r}
ggplot(us_sent) +
  geom_point(aes(y = sentence_length,
                 x = all_adjustments, color = as.factor(criminal_history)), alpha = 0.01) +
  labs(x = "All Adjustments",
       y = "Sentence length in months",
       color = "Criminal History") +
  facet_wrap(~ race) +
  scale_color_viridis_d()
```

```{r}
ggplot(us_sent) +
  geom_point(aes(y = sentence_length,
                 x = all_adjustments, color = as.factor(criminal_history)), alpha = 0.01) +
  labs(x = "All Adjustments",
       y = "Sentence length in months",
       color = "Criminal History") +
  scale_color_viridis_d()
```

#### How does the age range vary with criminal history?

```{r}
ggplot(us_sent) +
  geom_density_ridges(aes(y = as.factor(criminal_history),
                          x = age,
                          fill = as.factor(criminal_history))) +
  labs(fill = "Criminal History",
       x = "Age of individual in years",
       y = "Criminal History")
```

### When

Let's explore the time data found in our US sentencing data set. How many columns of data did we have again? This seems like a good place to start digging into what kind of time data we have in this data set. Which tool can we use to find out?


Do we remember?


We do remember; we can use the `names()` routine to remind ourselves.


```{r check the columns, i.e. names}
names(us_sent)
```

We can see the fifteen column names in that output.  Awesome.  Looks like our time data, as far as 'when' these convicted individuals in our data were convicted, is in the `year` column.  Let's see what we're working with here.  Let's use the pipe `distinct()` routine again.

```{r Segregate and list the data in the column year}
us_sent %>% distinct(year)
```

Excellent. So we have years from 2006 to 2020 in our data, or 15 rows worth of data.  It is worth noticing that although 2020-2006 = 14, when we count each year as a whole year of data 'inclusively', we have 15 distinct instances, which the distinct command helpfully listed out for us.

Now each of these data points is a numeric variable, such as '2010', or '2015'. One way we could check is to use the `sapply()` routine.


```{r}
sapply(us_sent, is.numeric)
```

In the output we can indeed see `TRUE` for the column `year`.  As we progress in our educational journey, learn about different numeric variables, including double precision floating point arithmetic numeric variables.  Is our `year` data in this format? Let's use the same command with a different argument:


```{r use sapply() to verify the year data is indeed numero}
sapply(us_sent, is.double)
```

Nice, we can see that our `year` data is indeed a double precision floating point number.


Let's do a graph of our `year` data, where we have each year on the vertical (y) axis and the sentences on the horizontal (x) axis.  

```{r Bar chart of year data}
ggplot(us_sent) +
  geom_bar(aes(y = year))
```



If we wanted to use a scatter plot, which could be a bit 'messier', one way to do so would be:
```{r graph our year data- scatter plot}
ggplot(us_sent, aes(x = sentence_length, 
                    y = year)) + 
  geom_point()
```

### Where

Let's check what districts we have in the data. We can do this using `distinct(district)`.

```{r}
us_sent %>%
  distinct(district)
```

You'll notice that certain states are a single district on their own. Other larger states are split into several districts (e.g. New York East, New York North).  

Q: If you live in the United States, can you identify which district you live in?

**To Do** Add a link to a reference where someone could also find which district their town/city is in.

We can use `distinct` to figure out what distinct districts we have in our dataset, but we are also interested in finding out how many sentences were made in each district and we will want to think about this question in relation to the population of those districts, which can be quite nuanced and we will come back to this later.

Our goals in this next section are to think about ways we can explore the question "Where did those sentences occur?" in a visual way.

**Learning aims**

- introduce factors as a data type
- explain why it might be better to put our names on the y axis instead of the x-axis for many categories and those with longer names. This makes it more readable.
- explain that automatically categorical data will be placed in alphabetical order.
- we can reconfigure the graph using functions from the `forcats` package.
- This is a good example for when you might want to order it in terms of frequency (i.e. the count) using `fct_infreq`
- We may also want to reverse the order to see the districts which have the most sentences at the top of our plot using `fct_rev`.

#### Number of individuals sentences across districts {.tabset}


##### Base Bar Plot

```{r}
ggplot(us_sent) +
  geom_bar(aes(x = district))
```

##### District on the y-axis

```{r}
ggplot(us_sent) +
  geom_bar(aes(y = district))
```

##### Ordered by number of sentences

```{r}
ggplot(us_sent) +
  geom_bar(aes(y = fct_infreq(district)))
```

##### Ordering from high to low

```{r}
ggplot(us_sent) +
  geom_bar(aes(y = fct_rev(fct_infreq(district))))
```

##### Add title and axes labels

```{r}
ggplot(us_sent) +
  geom_bar(aes(y = fct_rev(fct_infreq(district)))) +
  labs(title = "Number of individuals sentenced at the federal district court level for each district from x to x",
       y = "Federal District Court",
       x = "Number of individuals")
```

##### Making the plot more readable with subsetting

```{r}
ggplot(us_sent) +
  geom_bar(aes(y = fct_rev(fct_infreq(district)))) +
  labs(title = "Number of individuals sentenced at the federal district court level for each district from x to x",
       y = "Federal District Court",
       x = "Number of individuals")
```
```{r}
ggplot(us_sent) +
  geom_bar(aes(y = fct_infreq(district))) +
  labs(title = "Number of individuals sentenced at the federal district court level for each district from x to x",
       y = "Federal District Court",
       x = "Number of individuals")
```

##### Exploring the census data

**To Do**:

- If we want to get out the district populations, we will probably need to download the data by the county level.
- Decision points: we could download the data in categories by age and sex and race: e.g. 5-9, 10-14 etc. This might get a little

```{r census-data-import, echo = TRUE, warning = FALSE, message = FALSE, results = 'hide'}

# apply unique census api key
census_api_key("5177724b01a7fe4714097e711cb95230c37cfce7", overwrite = TRUE)

# import census data
## guide to spatial units: https://api.census.gov/data/2016/acs/acs5/geography.html
## variable of interest --> population
## vars <- load_variables(year = 2013,
                      # dataset = "acs5",
                      # cache = TRUE)

# B02001_001: Total
# B03002_003: White alone (Not Hispanic or Latino)
# B03002_004 Black or African American alone (Not Hispanic or Latino)
# B03002_012: Hispanic or Latino
# B03002_005: Native American alone (Not Hispanic or Latino)
# B03002_006: Asian alone (Not Hispanic or Latino)
# B03002_007: Native Hawaiian or Pacific Islander alone (Not Hispanic or Latino)
# B03002_009: Multiple Races (Not Hispanic or Latino)
# B03002_008: Other (Not Hispanic or Latino)

#census_place_df <- get_acs(geography = "state", variables = c("B01003_001E"), geometry = TRUE, year = 2010)

```
